name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Frontend CI/CD Job
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Check code formatting with Prettier
      run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}"

    - name: Run ESLint
      run: npm run lint --if-present

    - name: Type check with TypeScript
      run: npx tsc --noEmit

    - name: Run tests
      run: npm test -- --coverage --watchAll=false
      env:
        CI: true

    - name: Build frontend
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build-${{ matrix.node-version }}
        path: frontend/build/

  # Server Core Service CI/CD Job
  server-core:
    name: Server Core CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server/core

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: server/core/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Check code formatting with Prettier
      run: npx prettier --check "src/**/*.{ts,js,json}" --ignore-path .gitignore

    - name: Run ESLint
      run: npx eslint "src/**/*.{ts,js}" --max-warnings 0 || echo "ESLint not configured, skipping..."

    - name: Type check with TypeScript
      run: npx tsc --noEmit

    - name: Run tests
      run: npm test --if-present

    - name: Build server core
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: server-core-build-${{ matrix.node-version }}
        path: server/core/dist/

  # Server Auth Service CI/CD Job
  server-auth:
    name: Server Auth CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server/auth

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: server/auth/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Check code formatting with Prettier
      run: npx prettier --check "src/**/*.{ts,js,json}" --ignore-path .gitignore

    - name: Run ESLint
      run: npx eslint "src/**/*.{ts,js}" --max-warnings 0 || echo "ESLint not configured, skipping..."

    - name: Type check with TypeScript
      run: npx tsc --noEmit

    - name: Run tests
      run: npm test --if-present

    - name: Build server auth
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: server-auth-build-${{ matrix.node-version }}
        path: server/auth/dist/

  # Security and Quality Checks
  security:
    name: Security & Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Run npm audit for frontend
      run: |
        cd frontend
        npm audit --audit-level high || echo "Frontend audit completed with warnings"

    - name: Run npm audit for server core
      run: |
        cd server/core
        npm audit --audit-level high || echo "Server core audit completed with warnings"

    - name: Run npm audit for server auth
      run: |
        cd server/auth
        npm audit --audit-level high || echo "Server auth audit completed with warnings"

    - name: Check for sensitive files
      run: |
        if find . -name "*.env*" -not -path "./.git/*" -not -name "*.example*" | grep -q .; then
          echo "Warning: Found potential environment files"
          find . -name "*.env*" -not -path "./.git/*" -not -name "*.example*"
        fi