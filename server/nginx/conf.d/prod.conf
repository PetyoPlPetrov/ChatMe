# Production Environment Configuration
# Optimized and secure settings for production deployment

# Production upstream definitions with health checks and load balancing
upstream auth_service {
    server chatme-auth-prod:5001 max_fails=3 fail_timeout=30s;
    # Add more auth service instances here for load balancing
    # server chatme-auth-prod-2:5001 max_fails=3 fail_timeout=30s;

    # Connection keepalive for better performance
    keepalive 32;
}

upstream core_service {
    server chatme-core-prod:5000 max_fails=3 fail_timeout=30s;
    # Add more core service instances here for load balancing
    # server chatme-core-prod-2:5000 max_fails=3 fail_timeout=30s;

    # Connection keepalive for better performance
    keepalive 32;
}

# Production rate limiting (strict)
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=global:10m rate=50r/s;

# Additional rate limiting zones for production
limit_req_zone $http_x_forwarded_for zone=api_xff:10m rate=20r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

# Map for production environment
map $request_uri $environment {
    default "production";
}

# Production-specific server block overrides
server {
    # Global connection limiting
    limit_conn conn_limit_per_ip 20;

    # Production buffer sizes
    client_body_buffer_size 128k;
    client_max_body_size 10m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;

    # Production timeout settings (longer for stability)
    location /api/auth/ {
        # Production timeouts - longer for stability
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Production buffer settings
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # Production rate limiting for auth endpoints
        limit_req zone=auth burst=3 nodelay;
        limit_req zone=global burst=10 nodelay;

        # Connection keepalive
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    location /api/ {
        # Production timeouts - longer for stability
        proxy_connect_timeout 5s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        # Production buffer settings
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # Production rate limiting (strict)
        limit_req zone=api burst=5 nodelay;
        limit_req zone=global burst=10 nodelay;

        # Additional rate limiting based on X-Forwarded-For (for load balancers)
        limit_req zone=api_xff burst=10 nodelay;

        # Connection keepalive
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Production error handling (minimal information disclosure)
    location @error401 {
        return 401 '{"error":"Unauthorized","message":"Authentication required"}';
        add_header Content-Type application/json;
    }

    location @error403 {
        return 403 '{"error":"Forbidden","message":"Access denied"}';
        add_header Content-Type application/json;
    }

    location @error404 {
        return 404 '{"error":"Not Found","message":"Endpoint not found"}';
        add_header Content-Type application/json;
    }

    location @error50x {
        return 500 '{"error":"Internal Server Error","message":"Service temporarily unavailable"}';
        add_header Content-Type application/json;
    }
}

# Production logging (structured and minimal PII)
log_format prod_format '$remote_addr - [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       'rt=$request_time uct="$upstream_connect_time" '
                       'uht="$upstream_header_time" urt="$upstream_response_time" '
                       'xff="$http_x_forwarded_for" '
                       'ref="$http_referer"';

access_log /var/log/nginx/access.log prod_format;

# Production-specific additional settings
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m inactive=60m;
proxy_temp_path /var/cache/nginx/temp;

# Enable proxy caching for specific endpoints if needed
# location ~* ^/api/(users|public)/ {
#     proxy_cache api_cache;
#     proxy_cache_valid 200 302 5m;
#     proxy_cache_valid 404 1m;
#     proxy_cache_key "$scheme$request_method$host$uri$is_args$args";
#     add_header X-Cache-Status $upstream_cache_status;
# }