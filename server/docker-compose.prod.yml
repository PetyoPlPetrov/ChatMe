services:
  # ChatMe Nginx Gateway - Production Mode
  chatme-nginx-prod:
    image: nginx:alpine
    container_name: chatme-nginx-prod
    ports:
      - "8080:80"
    environment:
      # Core service configuration
      - ENVIRONMENT=production
      - SERVER_NAME=chatme.com
      - AUTH_SERVICE_HOST=chatme-auth-prod
      - AUTH_SERVICE_PORT=5001
      - CORE_SERVICE_HOST=chatme-core-prod
      - CORE_SERVICE_PORT=5000
      # Production upstream settings (with health checks and keepalive)
      - UPSTREAM_OPTIONS= max_fails=3 fail_timeout=30s
      - DEV_BACKUP_SERVER=
      - DEV_BACKUP_SERVER_CORE=
      - "KEEPALIVE_CONFIG=keepalive 32;"
      # Rate limiting (strict for production)
      - API_RATE_LIMIT=10r/s
      - AUTH_RATE_LIMIT=5r/s
      - API_BURST=5
      - AUTH_BURST=3
      # CORS configuration (production domains)
      - CORS_ORIGIN=https://chatme.com
      - CORS_METHODS=GET, POST, PUT, DELETE, OPTIONS
      - CORS_HEADERS=Authorization, Content-Type, Accept, Origin, X-Requested-With
      # Security headers (production - strict)
      - X_FRAME_OPTIONS=DENY
      - "CSP_POLICY=default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self'; font-src 'self'; object-src 'none'; media-src 'self'; frame-src 'none';"
      - "HSTS_HEADER=add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains; preload\" always;"
      - REFERRER_POLICY=strict-origin-when-cross-origin
      # Timeout settings (production - longer for stability)
      - AUTH_CONNECT_TIMEOUT=5s
      - AUTH_SEND_TIMEOUT=60s
      - AUTH_READ_TIMEOUT=60s
      - API_CONNECT_TIMEOUT=5s
      - API_SEND_TIMEOUT=120s
      - API_READ_TIMEOUT=120s
      # Logging
      - LOG_FORMAT=prod_format
      - LOG_PATTERN=$$remote_addr - [$$time_local] "$$request" $$status $$body_bytes_sent rt=$$request_time uct="$$upstream_connect_time" uht="$$upstream_header_time" urt="$$upstream_response_time" xff="$$http_x_forwarded_for" ref="$$http_referer"
      # Production-only features
      - "PROD_RATE_LIMITING_ZONES=limit_req_zone $$binary_remote_addr zone=global:10m rate=50r/s; limit_req_zone $$http_x_forwarded_for zone=api_xff:10m rate=20r/s;"
      - "PROD_CONNECTION_ZONES=limit_conn_zone $$binary_remote_addr zone=conn_limit_per_ip:10m;"
      - "PROD_CACHE_CONFIG=proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m inactive=60m; proxy_temp_path /var/cache/nginx/temp;"
      - "PROD_CONNECTION_LIMITS=limit_conn conn_limit_per_ip 20;"
      - "PROD_BUFFER_SETTINGS=client_body_buffer_size 128k; client_max_body_size 10m; client_header_buffer_size 1k; large_client_header_buffers 4 4k;"
      - "PROD_AUTH_RATE_LIMITING=limit_req zone=global burst=10 nodelay;"
      - "PROD_AUTH_BUFFER_SETTINGS=proxy_buffer_size 4k; proxy_buffers 8 4k; proxy_busy_buffers_size 8k;"
      - "PROD_AUTH_KEEPALIVE=proxy_http_version 1.1; proxy_set_header Connection \"\";"
      - "PROD_API_RATE_LIMITING=limit_req zone=global burst=10 nodelay; limit_req zone=api_xff burst=10 nodelay;"
      - "PROD_API_BUFFER_SETTINGS=proxy_buffer_size 4k; proxy_buffers 8 4k; proxy_busy_buffers_size 8k;"
      - "PROD_API_KEEPALIVE=proxy_http_version 1.1; proxy_set_header Connection \"\";"
      - "PROD_ADDITIONAL_SECURITY_HEADERS=add_header Permissions-Policy \"geolocation=(), microphone=(), camera=()\" always; add_header X-Permitted-Cross-Domain-Policies \"none\" always;"
    volumes:
      # Base nginx.conf and template
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/nginx.conf.template:/etc/nginx/templates/nginx.conf.template:ro
      # Disable the default.conf from nginx:alpine to avoid conflicts
      - /dev/null:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - chatme-core-prod
      - chatme-auth-prod
    networks:
      - chatme-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.25'
          memory: 64M
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ChatMe Core Service - Production Mode
  chatme-core-prod:
    build:
      context: ./core
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
    container_name: chatme-core-prod
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
    networks:
      - chatme-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ChatMe Auth Service - Production Mode
  chatme-auth-prod:
    build:
      context: ./auth
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
    container_name: chatme-auth-prod
    ports:
      - "5001:5001"
    environment:
      - NODE_ENV=production
      - PORT=5001
    networks:
      - chatme-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  chatme-network:
    driver: bridge
    name: chatme-network

volumes:
  # Volume for node_modules to persist dependencies
  chatme-server-node-modules:
    name: chatme-server-node-modules